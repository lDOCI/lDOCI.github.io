<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flashforge AD5M Wiki</title>
    
    <!-- Стили (Tailwind) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Логика (Vue 3) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Иконки (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Markdown Парсер -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Шрифты -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace']
                    },
                    colors: {
                        bg: { main: '#0a0a0a', card: '#121212', border: '#262626', hover: '#1f1f1f' },
                        brand: { DEFAULT: '#f97316', glow: 'rgba(249, 115, 22, 0.15)' }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #0a0a0a; color: #e5e5e5; }
        
        /* Markdown стили внутри карточки */
        .prose strong { color: #fff; font-weight: 600; }
        .prose ul { list-style-type: disc; padding-left: 1.2rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .prose ol { list-style-type: decimal; padding-left: 1.2rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .prose code { background: #2a2a2a; padding: 2px 5px; border-radius: 4px; font-family: 'JetBrains Mono'; font-size: 0.85em; color: #f97316; }
        .prose p { margin-bottom: 0.8em; }
        .prose a { color: #f97316; text-decoration: underline; }

        /* Анимация подсветки */
        @keyframes target-fade {
            0% { border-color: #f97316; box-shadow: 0 0 30px rgba(249, 115, 22, 0.3); }
            100% { border-color: #262626; box-shadow: none; }
        }
        .target-active { animation: target-fade 2s ease-out forwards; }
        
        /* Скроллбар */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }
    </style>
</head>
<body class="antialiased h-screen overflow-hidden flex flex-col md:flex-row">

<div id="app" class="w-full h-full flex flex-col md:flex-row">

    <!-- МОБИЛЬНАЯ ШАПКА -->
    <div class="md:hidden h-16 border-b border-bg-border bg-bg-main/80 backdrop-blur flex items-center justify-between px-4 z-50 shrink-0">
        <div class="flex items-center gap-2 font-bold text-lg">
            <div class="w-6 h-6 bg-brand rounded flex items-center justify-center text-black text-xs">5M</div>
            <span>Wiki</span>
        </div>
        <button @click="mobileMenu = !mobileMenu" class="p-2 text-zinc-400 hover:text-white">
            <i :data-lucide="mobileMenu ? 'x' : 'menu'" class="w-6 h-6"></i>
        </button>
    </div>

    <!-- САЙДБАР (Навигация) -->
    <aside :class="['fixed inset-y-0 left-0 w-72 bg-bg-card border-r border-bg-border z-40 transform transition-transform duration-300 md:relative md:translate-x-0 flex flex-col', mobileMenu ? 'translate-x-0' : '-translate-x-full']">
        
        <!-- Логотип (Desktop) -->
        <div class="hidden md:flex h-16 items-center px-6 border-b border-bg-border gap-3">
            <div class="w-8 h-8 bg-brand rounded-lg flex items-center justify-center text-black font-bold shadow-[0_0_15px_rgba(249,115,22,0.4)]">5M</div>
            <div>
                <h1 class="font-bold leading-none">AD5M Wiki</h1>
                <span class="text-[10px] text-zinc-500 font-mono">Community Base</span>
            </div>
        </div>

        <!-- Поиск -->
        <div class="p-4">
            <div class="relative group">
                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500 w-4 h-4 group-focus-within:text-brand transition"></i>
                <input type="text" v-model="search" placeholder="Поиск (ремень, ошибка...)" 
                       class="w-full bg-bg-main border border-bg-border rounded-lg py-2.5 pl-10 pr-3 text-sm text-white placeholder-zinc-600 focus:border-brand focus:ring-1 focus:ring-brand outline-none transition-all">
            </div>
        </div>

        <!-- Меню -->
        <nav class="flex-1 overflow-y-auto px-3 space-y-1 py-2">
            <div v-for="cat in categories" :key="cat.id">
                <button @click="setCategory(cat.id)"
                    :class="['w-full flex items-center justify-between px-3 py-2.5 rounded-lg text-sm font-medium transition-all',
                             currentTab === cat.id 
                             ? 'bg-brand/10 text-brand border border-brand/20' 
                             : 'text-zinc-400 hover:bg-bg-hover hover:text-white border border-transparent']">
                    <div class="flex items-center gap-3">
                        <i :data-lucide="cat.icon" class="w-4 h-4"></i>
                        {{ cat.name }}
                    </div>
                    <span class="text-xs text-zinc-600 bg-bg-main px-1.5 py-0.5 rounded">{{ getCount(cat.id) }}</span>
                </button>
            </div>
        </nav>

        <!-- Футер -->
        <div class="p-4 border-t border-bg-border text-xs text-zinc-600 text-center">
            База сгенерирована AI<br>на основе чата Telegram
        </div>
    </aside>

    <!-- ЗАТЕМНЕНИЕ ФОНА (Мобилка) -->
    <div v-if="mobileMenu" @click="mobileMenu = false" class="fixed inset-0 bg-black/80 z-30 md:hidden backdrop-blur-sm"></div>

    <!-- КОНТЕНТ -->
    <main class="flex-1 h-full overflow-y-auto scroll-smooth relative" ref="mainScroll">
        <div class="max-w-5xl mx-auto px-4 py-8 md:px-8 md:py-12">

            <!-- Заголовок раздела -->
            <div class="mb-8 flex items-end justify-between border-b border-bg-border pb-4">
                <div>
                    <h2 class="text-3xl font-bold text-white">{{ getCategoryName(currentTab) }}</h2>
                    <p class="text-zinc-500 mt-1 text-sm">Найдено статей: {{ filteredArticles.length }}</p>
                </div>
            </div>

            <!-- СПИННЕР ЗАГРУЗКИ -->
            <div v-if="loading" class="flex flex-col items-center justify-center py-20">
                <div class="w-10 h-10 border-4 border-bg-border border-t-brand rounded-full animate-spin mb-4"></div>
                <p class="text-zinc-500 animate-pulse">Загрузка базы знаний...</p>
            </div>

            <!-- ПУСТО -->
            <div v-else-if="filteredArticles.length === 0" class="text-center py-20 border border-dashed border-bg-border rounded-xl bg-bg-card/50">
                <i data-lucide="search-x" class="w-12 h-12 text-zinc-700 mx-auto mb-4"></i>
                <h3 class="text-lg font-medium text-zinc-300">Ничего не найдено</h3>
                <p class="text-zinc-500 text-sm mt-1">Попробуйте другой запрос или категорию "Все"</p>
                <button @click="search = ''; currentTab = 'all'" class="mt-4 text-brand hover:underline text-sm">Сбросить фильтры</button>
            </div>

            <!-- СЕТКА СТАТЕЙ -->
            <div v-else class="grid grid-cols-1 gap-6">
                <article v-for="item in filteredArticles" :key="item.id" :id="'post-' + item.id"
                         class="bg-bg-card border border-bg-border rounded-xl p-6 hover:border-zinc-600 transition-all duration-300 group scroll-mt-20">
                    
                    <!-- Хедер статьи -->
                    <div class="flex flex-wrap items-start justify-between gap-4 mb-4">
                        <div class="flex flex-wrap gap-2">
                            <!-- БЕЙДЖИ -->
                            <span v-for="badge in item.badges" :key="badge.text"
                                  :class="['px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider border', getBadgeColor(badge.color)]">
                                {{ badge.text }}
                            </span>
                            <!-- ТЕГИ -->
                            <span v-for="tag in item.tags" :key="tag" 
                                  class="px-2 py-1 rounded text-[10px] text-zinc-400 bg-bg-main border border-bg-border">
                                #{{ tag }}
                            </span>
                        </div>

                        <!-- Кнопка ссылки -->
                        <button @click="copyLink(item.id)" class="text-zinc-600 hover:text-brand transition p-1 opacity-0 group-hover:opacity-100" title="Скопировать ссылку">
                            <i data-lucide="link" class="w-4 h-4"></i>
                        </button>
                    </div>

                    <!-- Заголовок -->
                    <h3 class="text-xl font-bold text-white mb-4 leading-tight flex gap-3">
                        <i data-lucide="help-circle" class="w-6 h-6 text-zinc-600 shrink-0 mt-0.5"></i>
                        {{ item.problem }}
                    </h3>

                    <!-- Решение (Markdown) -->
                    <div class="pl-9 relative">
                        <div class="absolute left-3 top-2 bottom-2 w-0.5 bg-bg-border"></div>
                        <!-- Рендерим Markdown через marked -->
                        <div class="prose text-zinc-300 text-sm leading-relaxed max-w-none" v-html="renderMarkdown(item.solution)"></div>
                    </div>

                    <!-- ID -->
                    <div class="mt-4 pt-4 border-t border-bg-border flex justify-end">
                        <span class="text-[10px] text-zinc-700 font-mono">ID: {{ item.id }}</span>
                    </div>
                </article>
            </div>

            <div class="h-12"></div> <!-- Отступ снизу -->
        </div>
    </main>

    <!-- TOAST -->
    <div v-show="toast.show" class="fixed bottom-6 right-6 z-50 bg-brand text-black font-bold px-4 py-3 rounded-lg shadow-[0_0_20px_rgba(249,115,22,0.4)] flex items-center gap-3 animate-bounce">
        <i data-lucide="check" class="w-5 h-5"></i> Ссылка скопирована!
    </div>

</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                loading: true,
                articles: [],
                search: '',
                currentTab: 'all',
                mobileMenu: false,
                toast: { show: false },
                categories: [
                    { id: 'all', name: 'Все статьи', icon: 'layers' },
                    { id: 'start', name: 'Новичкам (Start)', icon: 'sprout' },
                    { id: 'fix', name: 'Ремонт и Ошибки', icon: 'wrench' },
                    { id: 'mod', name: 'Моды и Тюнинг', icon: 'cpu' },
                    { id: 'models', name: '3D Модели', icon: 'box' }
                ]
            }
        },
        computed: {
            filteredArticles() {
                let result = this.articles;
                
                // Фильтр по категории
                if (this.currentTab !== 'all') {
                    result = result.filter(a => {
                        const c = (a.category || 'info').toLowerCase();
                        // Обработка синонимов из нейросети
                        if (this.currentTab === 'mod' && (c.includes('klipper') || c.includes('z-mod'))) return true;
                        if (this.currentTab === 'fix' && (c.includes('error') || c.includes('quality'))) return true;
                        return c.includes(this.currentTab);
                    });
                }

                // Поиск
                if (this.search) {
                    const q = this.search.toLowerCase();
                    result = result.filter(a => 
                        a.problem.toLowerCase().includes(q) || 
                        a.solution.toLowerCase().includes(q) ||
                        (a.tags && a.tags.some(t => t.toLowerCase().includes(q)))
                    );
                }
                return result;
            }
        },
        methods: {
            async loadData() {
                try {
                    // ЗАГРУЗКА JSON ФАЙЛА
                    const response = await fetch('db.json');
                    if (!response.ok) throw new Error('Нет файла db.json');
                    this.articles = await response.json();
                    
                    // Проверяем хеш ссылки после загрузки
                    this.$nextTick(() => {
                        this.checkHash();
                        lucide.createIcons();
                    });
                } catch (e) {
                    console.error(e);
                    // Для теста, если файла нет - пустой массив
                    this.articles = [];
                } finally {
                    this.loading = false;
                }
            },
            renderMarkdown(text) {
                if (!text) return '';
                return marked.parse(text);
            },
            setCategory(id) {
                this.currentTab = id;
                this.mobileMenu = false;
                this.$refs.mainScroll.scrollTop = 0;
            },
            getCategoryName(id) {
                const cat = this.categories.find(c => c.id === id);
                return cat ? cat.name : 'База знаний';
            },
            getCount(id) {
                if (id === 'all') return this.articles.length;
                // Та же логика фильтрации для счетчика
                return this.articles.filter(a => {
                    const c = (a.category || 'info').toLowerCase();
                    if (id === 'mod' && (c.includes('klipper') || c.includes('z-mod'))) return true;
                    if (id === 'fix' && (c.includes('error') || c.includes('quality'))) return true;
                    return c.includes(id);
                }).length;
            },
            getBadgeColor(color) {
                const map = {
                    'blue': 'bg-blue-500/10 text-blue-400 border-blue-500/20',
                    'purple': 'bg-purple-500/10 text-purple-400 border-purple-500/20',
                    'orange': 'bg-orange-500/10 text-orange-400 border-orange-500/20',
                    'red': 'bg-red-500/10 text-red-400 border-red-500/20',
                    'green': 'bg-green-500/10 text-green-400 border-green-500/20',
                };
                return map[color] || 'bg-zinc-800 text-zinc-400 border-zinc-700';
            },
            copyLink(id) {
                const url = `${window.location.origin}${window.location.pathname}#post-${id}`;
                navigator.clipboard.writeText(url);
                history.pushState(null, null, `#post-${id}`);
                this.toast.show = true;
                setTimeout(() => this.toast.show = false, 2000);
            },
            checkHash() {
                const hash = window.location.hash;
                if (hash && hash.includes('post-')) {
                    const id = hash.replace('#post-', '');
                    const item = this.articles.find(a => a.id == id);
                    
                    if (item) {
                        // Переключаем категорию чтобы показать пост
                        this.currentTab = 'all';
                        // Скроллим
                        this.$nextTick(() => {
                            const el = document.getElementById('post-' + id);
                            if (el) {
                                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                el.classList.add('target-active');
                            }
                        });
                    }
                }
            }
        },
        mounted() {
            this.loadData();
            lucide.createIcons();
        },
        updated() {
            lucide.createIcons();
        }
    }).mount('#app');
</script>

</body>
</html>